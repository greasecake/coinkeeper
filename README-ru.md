# Сервис для интеграции с Livetex
[![en](https://img.shields.io/badge/lang-en-red.svg)](https://github.com/greasecake/coinkeeper/blob/master/README.md)
[![ru](https://img.shields.io/badge/lang-ru-blue.svg)](https://github.com/greasecake/coinkeeper/blob/master/README-ru.md)

## Обзор

Это приложение на Python, созданное с использованием Flask для обработки событий webhook. Оно интегрируется с Livetex Bot API для реагирования на действия посетителей и маршрутизации сообщений операторам.

## Начало работы

Следуйте этим шагам, чтобы настроить и запустить проект локально.

### Установка

 `pip install -r requirements.txt`

### Настройка

- В папке с приложением необходимо создать файл `channel_tokens.json` с соответствием [id точки контакта](https://my.livetex.ru/settings/touch_points) и [токенов](https://my.livetex.ru/channels/bot).

Пример:
```json
{
  "123456": "112233:00000000-aaaa-0000-aaaa-00000000aaaa",  
  "789012": "445566:11111111-bbbb-1111-bbbb-11111111bbbb"
}
```

## Использование

`python app.py`

Приложение прослушивает входящие POST-запросы по адресу `/bot-api/webhook`. Оно обрабатывает события webhook, реагирует на действия посетителей и маршрутизирует сообщения операторам.

### Вебхук-конечные точки

- `POST /bot-api/webhook`: Обработка входящих событий webhook.
- `GET /bot-api/webhook`: Получение первоначальных настроек.

Для более подробной информации о взаимодействии с API обратитесь к [документации Livetex]([url](https://support.livetex.ru/hc/ru/articles/4411890908305-Bot-API)) и предоставленному примеру скрипта (`conversation_tree.yml`).

## Логирование и Обработка Ошибок

В проекте внедрено логирование и обработка ошибок. Логи пишутся в `stdout`, а ошибки дополнительно логируются в файл `error.log`.

### Логирование

- Логи событий: Логируются входящие POST-запросы, включая `channel_id` и `visitor_id`, для отслеживания событий.

### Обработка Ошибок

- Все обработчики запросов (`get_reply` и `get_settings`) включают обработку ошибок и логирование ошибок в случае их возникновения.

- В случае ошибки, клиенту возвращается сообщение об ошибке с соответствующим статусом и кодом состояния.

---

# Структура файла `conversation_tree.yml`

Файл `conversation_tree.yml` используется для определения структуры и содержания ответов на различные события webhook в проекте. Этот файл YAML организует ответы в иерархическую структуру, позволяя гибко настраивать ответы чатбота.

## Структура YAML

Файл `conversation_tree.yml` следует иерархической структуре с вложенными узлами, которые представляют разные этапы беседы или ответы. Каждый узел может содержать текст и варианты кнопок.

### Пример структуры `conversation_tree.yml`:

```yaml
root:
  text: "Добро пожаловать в нашего чатбота! Как мы можем вам помочь сегодня?"
  children:
    greeting:
      text: "Привет! Как я могу вам помочь?"
      children:
        menu:
          text: "Вот некоторые варианты:"
          children:
            option1:
              text: "Вариант 1: Узнать больше"
            option2:
              text: "Вариант 2: Уточнить запрос"
            operator:
              text: "Вариант 3: Связаться с оператором"
```

В этом примере:

- `root` - это верхний уровень узла и служит точкой начала разговора.
- У каждого узла может быть поле `text`, содержащее текст ответа чатбота.
- Узлы могут иметь детей (подузлы), что позволяет создавать иерархию ответов.
- `operator` - это зарезервированное имя узла. Если пользователь попадает туда, его обращение переводится свободному оператору группы. Таких узлов может быть несколько в разных точках дерева.

### Параметры ответов

Для каждого узла можно определить следующие параметры:

- `text`: Текстовое сообщение, которое отправит чатбот.
- `children`: Вложенные узлы, представляющие возможные следующие ответы.
- `button`: Необязательное поле, которое определяет текст на кнопке ответа.

### Использование

Файл `conversation_tree.yml` используется в коде для определения текстовых ответов и кнопок на основе передаваемого в webhook события. Узлы в YAML-структуре идентифицируются с помощью ключей и могут быть использованы в данных payload.

Пример использования ключа в данных payload: `"payload": "options.option1"` означает, что чатбот извлечет текстовый ответ из узла `option1` в структуре `options`.

### Настройка

Настройте файл `conversation_tree.yml` в соответствии с требованиями вашего чатбота и желаемой структурой диалога.
